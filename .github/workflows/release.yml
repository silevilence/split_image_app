# SmartGridSlicer - è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
# è§¦å‘æ¡ä»¶: æ¨é€ v* æ ¼å¼çš„ Tag (å¦‚ v1.0.0)

name: Release

on:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.32.2'

jobs:
  # ç‰ˆæœ¬éªŒè¯ Job
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_version: ${{ steps.get_version.outputs.tag_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag and pubspec
        id: get_version
        shell: pwsh
        run: |
          # ä» Tag è·å–ç‰ˆæœ¬å· (å»é™¤ v å‰ç¼€)
          $tagVersion = "${{ github.ref_name }}".TrimStart('v')
          echo "tag_version=$tagVersion" >> $env:GITHUB_OUTPUT
          
          # ä» pubspec.yaml è·å–ç‰ˆæœ¬å·
          $pubspecContent = Get-Content pubspec.yaml -Raw
          if ($pubspecContent -match 'version:\s*(\d+\.\d+\.\d+)') {
            $pubspecVersion = $matches[1]
            echo "version=$pubspecVersion" >> $env:GITHUB_OUTPUT
          } else {
            echo "::error::Cannot find version in pubspec.yaml"
            exit 1
          }
          
          # éªŒè¯ç‰ˆæœ¬å·åŒ¹é…
          if ($tagVersion -ne $pubspecVersion) {
            echo "::error::Tag version ($tagVersion) does not match pubspec.yaml version ($pubspecVersion)"
            exit 1
          }
          
          echo "âœ… Version validated: $pubspecVersion"

  # Windows æ„å»º Job
  build-windows:
    name: Build Windows
    needs: validate
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run flutter analyze
        run: flutter analyze

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Rename executable (optional branding)
        shell: pwsh
        run: |
          $buildPath = "build\windows\x64\runner\Release"
          # å¦‚æœéœ€è¦é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
          # Rename-Item "$buildPath\split_image_app.exe" "SmartGridSlicer.exe"
          
          # æ˜¾ç¤ºæ„å»ºäº§ç‰©
          Get-ChildItem $buildPath -Recurse | Select-Object FullName

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ needs.validate.outputs.version }}"
          $buildPath = "build\windows\x64\runner\Release"
          $zipName = "SmartGridSlicer-$version-windows-portable.zip"
          
          # åˆ›å»ºä¾¿æºç‰ˆ ZIP
          Compress-Archive -Path "$buildPath\*" -DestinationPath $zipName -Force
          echo "Created: $zipName"

      - name: Setup Inno Setup
        shell: pwsh
        run: |
          # ä¸‹è½½ Inno Setup
          $innoUrl = "https://jrsoftware.org/download.php/is.exe"
          $innoInstaller = "$env:TEMP\innosetup.exe"
          Invoke-WebRequest -Uri $innoUrl -OutFile $innoInstaller
          
          # é™é»˜å®‰è£…
          Start-Process -FilePath $innoInstaller -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
          
          # æ·»åŠ åˆ° PATH
          $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6"
          echo "$innoPath" >> $env:GITHUB_PATH

      - name: Build Installer
        shell: pwsh
        run: |
          $version = "${{ needs.validate.outputs.version }}"
          $buildPath = "${{ github.workspace }}\build\windows\x64\runner\Release"
          $outputPath = "${{ github.workspace }}"
          
          # ç¼–è¯‘å®‰è£…ç¨‹åº
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" `
            "/DAppVersion=$version" `
            "/DBuildPath=$buildPath" `
            "/DOutputPath=$outputPath" `
            "scripts\installer.iss"

      - name: Upload Portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: SmartGridSlicer-portable
          path: SmartGridSlicer-*-windows-portable.zip

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: SmartGridSlicer-installer
          path: SmartGridSlicer-*-setup.exe

  # åˆ›å»º Release Job
  release:
    name: Create Release
    needs: [validate, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -R artifacts

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat << EOF > release_notes.md
          ## SmartGridSlicer v${VERSION}
          
          ### ğŸ“¦ ä¸‹è½½
          - **ä¾¿æºç‰ˆ (Portable)**: è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
          - **å®‰è£…ç‰ˆ (Installer)**: æ ‡å‡† Windows å®‰è£…ç¨‹åº
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64-bit)
          - æ— éœ€é¢å¤–è¿è¡Œæ—¶ä¾èµ–
          
          ### ğŸ”„ æ›´æ–°è¯´æ˜
          è¯·æŸ¥çœ‹ [ROADMAP.md](https://github.com/${{ github.repository }}/blob/main/ROADMAP.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ---
          > é¦–æ¬¡ä½¿ç”¨ï¼Ÿè¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) è·å–ä½¿ç”¨æŒ‡å—ã€‚
          EOF
          
          echo "Generated release notes"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: SmartGridSlicer v${{ needs.validate.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            artifacts/SmartGridSlicer-portable/*
            artifacts/SmartGridSlicer-installer/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
